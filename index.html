<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <title>Spritkostenrechner ‚Äì Fahrtkosten berechnen, Spritkosten teilen & CO‚ÇÇ vergleichen | Spritkosten-Check.de</title>
  <meta name="description" content="Kostenloser Spritkosten-Rechner f√ºr Fahrten & Roadtrips. Berechne Spritkosten, Gesamtkosten und Maut-/Vignetten-Sch√§tzung mit Karte und Distanzberechnung weltweit." />
  <meta name="robots" content="index, follow" />

  <link rel="canonical" href="https://spritkosten-check.de/" />
  <link rel="alternate" hreflang="de" href="https://spritkosten-check.de/" />
  <link rel="alternate" hreflang="en" href="https://petrolcostcalculator.com/" />
  <link rel="alternate" hreflang="x-default" href="https://petrolcostcalculator.com/" />

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" href="/favicon.ico">

  <!-- ‚úÖ Global CSS -->
  <link rel="stylesheet" href="/assets/css/style.css?v=2026-02" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "Spritkosten-Rechner",
    "description": "Kostenloser Online-Rechner f√ºr Spritkosten, Kraftstoffpreise, Maut/Vignette und Reisekosten",
    "url": "https://spritkosten-check.de",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Web",
    "offers": {"@type":"Offer","price":"0","priceCurrency":"EUR"}
  }
  </script>
</head>

<body data-page="home">

  <!-- ‚úÖ Header wird extern geladen -->
  <div id="site-header"></div>

  <!-- ‚úÖ Nur EIN main auf der Seite -->
  <main class="page-container" aria-label="Seiteninhalt">

    <!-- Ad: Top -->
    <div class="ad-block">
      <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-4852698472752437"
        data-ad-slot="7158625008"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    </div>

    <!-- Intro -->
    <section class="card intro-section" aria-label="Einf√ºhrung Spritkosten-Rechner">
      <h2>Kostenloser Spritkosten-Rechner ‚Äì Plane deine Fahrtkosten</h2>
      <p>
        Unser <strong>Spritkosten-Rechner</strong> hilft dir, die Gesamtkosten deiner Fahrt zu sch√§tzen.
        <strong>Kostenlos ‚Äì ohne Anmeldung.</strong>
        Gib Strecke, Verbrauch und Spritpreis ein ‚Äì du erh√§ltst eine Aufschl√ºsselung aus Spritkosten, laufenden Kosten und einer Maut-/Vignetten-Sch√§tzung.
      </p>
      <ul>
        <li><strong>Weltweit:</strong> Orte per OpenStreetMap</li>
        <li><strong>Strecke:</strong> echte Stra√üenroute + Karte</li>
        <li><strong>Maut/Vignette:</strong> schnelle Sch√§tzung nach L√§ndern</li>
        <li><strong>Kosten teilen:</strong> pro Person berechnen</li>
      </ul>
    </section>

    <!-- Rechner -->
    <section aria-label="Hauptinhalt">
      <section id="fuel" class="card">

        <!-- Ad: Middle -->
        <div class="ad-block">
          <ins class="adsbygoogle"
            style="display:block"
            data-ad-client="ca-pub-4852698472752437"
            data-ad-slot="3355111369"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
        </div>

        <div class="layout">

          <!-- LEFT -->
          <div>
            <h2 style="margin:0 0 8px 0;font-size:1rem">Eingaben</h2>

            <label for="km">Strecke (km) ‚Äî oder per Start/Ziel berechnen</label>

            <!-- ‚úÖ Spinner bleibt bei KM -->
            <div class="km-row">
              <input id="km" class="km-input" type="number" inputmode="decimal" min="0" step="0.1"
                placeholder="z. B. 120,5" aria-label="Strecke in Kilometern" />
              <div class="spinner" title="Strecke erh√∂hen / verringern">
                <button id="km-inc" aria-label="Strecke erh√∂hen" type="button">‚ñ≤</button>
                <button id="km-dec" aria-label="Strecke verringern" type="button">‚ñº</button>
              </div>
            </div>

        <div style="margin-top:12px">
  <label for="place-from">Oder: Start (Ort, Land)</label>
  <input id="place-from" type="text"
    placeholder="z. B. Paris, Frankreich"
    aria-label="Startort"
    autocomplete="off"
    autocapitalize="off"
    autocorrect="off"
    spellcheck="false" />

  <label for="place-to" style="margin-top:10px">Ziel (Ort, Land)</label>
  <input id="place-to" type="text"
    placeholder="z. B. Berlin, Deutschland"
    aria-label="Zielort"
    autocomplete="off"
    autocapitalize="off"
    autocorrect="off"
    spellcheck="false" />

  <div class="small" style="margin-top:4px">
    Beispiel: <b>Paris, Frankreich</b> ‚Üí <b>Berlin, Deutschland</b>
  </div>

  <div class="route-actions">
    <button id="btn-geocode" class="btn secondary" type="button">Strecke berechnen</button>
    <button id="btn-clearmap" class="btn secondary" type="button">Karte zur√ºcksetzen</button>
  </div>

  <div class="country-badge" id="country-badge"></div>

  <div class="price-mode" id="price-mode">
    <div class="small" style="margin-bottom:6px;">
      Startland und Zielland sind unterschiedlich. Welcher Spritpreis soll gelten?
    </div>
    <div class="row">
      <label class="pill"><input type="radio" name="priceMode" value="start"> Startland</label>
      <label class="pill"><input type="radio" name="priceMode" value="avg" checked> Mittelwert</label>
      <label class="pill"><input type="radio" name="priceMode" value="dest"> Zielland</label>
    </div>
  </div>
</div>

            <label for="fuel-type" style="margin-top:12px">Kraftstoff</label>
            <select id="fuel-type" aria-label="Kraftstoff">
              <option value="unleaded91">Benzin (E10/91)</option>
              <option value="unleaded95">Super (E5 / 95)</option>
              <option value="diesel">Diesel</option>
            </select>

            <label for="consumption" style="margin-top:12px">Verbrauch (L/100 km)</label>
            <input id="consumption" type="number" inputmode="decimal" min="0" step="0.1"
              value="7.5" placeholder="z. B. 7,5" aria-label="Kraftstoffverbrauch" />

            <!-- ‚úÖ Preisblock (KORREKT, nur 1 Button, keine kaputten </div>) -->
            <div class="price-input-group">
              <div class="price-field">
                <label for="price">Preis pro Liter (‚Ç¨)</label>
                <input id="price" type="number" inputmode="decimal" min="0" step="0.01"
                  placeholder="z. B. 1,89" aria-label="Spritpreis pro Liter" />
              </div>

              <button id="btn-reset-price" class="btn secondary reset-price-btn" type="button">
                Auf Standard zur√ºcksetzen
              </button>

              <span id="price-info" class="hint"></span>
            </div>

            <div class="price-table">
              <div class="price-card">
                <div class="small">√ò Benzin (E10)</div>
                <strong id="avg-unleaded91">‚Äî</strong>
              </div>
              <div class="price-card">
                <div class="small">√ò Super (E5)</div>
                <strong id="avg-unleaded95">‚Äî</strong>
              </div>
              <div class="price-card">
                <div class="small">√ò Diesel</div>
                <strong id="avg-diesel">‚Äî</strong>
              </div>
            </div>

            <label for="passengers" style="margin-top:12px">Personen (inkl. Fahrer)</label>
            <input id="passengers" type="number" min="1" step="1" value="1" aria-label="Anzahl Personen" />

            <div class="big-action">
              <button id="calc-fuel" class="btn large" type="button">Berechnen</button>
              <button id="reset-fuel" class="btn secondary large" type="button">Zur√ºcksetzen</button>
            </div>

            <div class="resultbox" aria-live="polite" aria-label="Ergebnisse">
              <div class="result-row"><div class="result-key">Spritkosten</div><div class="result-val" id="cost-fuel">‚Ç¨0,00</div></div>
              <div class="result-row"><div class="result-key">Laufende Kosten inkl. Maut/Vignette (Sch√§tzung)</div><div class="result-val" id="cost-running">‚Ç¨0,00</div></div>
              <div class="result-row"><div class="result-key">Gesamtkosten</div><div class="result-val" id="cost-total">‚Ç¨0,00</div></div>
              <div class="result-row"><div class="result-key">Pro Person</div><div class="result-val" id="cost-person">‚Ç¨0,00</div></div>
              <div class="result-row"><div class="result-key">Liter gesamt</div><div class="result-val" id="liters">0,00 L</div></div>
              <div class="result-row"><div class="result-key">Durchschnitt (‚Ç¨/100 km)</div><div class="result-val" id="avg100">‚Ç¨0,00 /100km</div></div>
              <div class="result-row"><div class="result-key small">Sch√§tzung laufende Kosten /100 km (inkl. Maut/Vignette)</div><div class="result-val small" id="running-est">‚Äî</div></div>
              <div style="margin-top:8px;color:var(--muted);font-size:.85rem">
                Laufende Kosten enthalten: Wartung, Reifen, Wertverlust, Versicherung + Maut/Vignette-Sch√§tzung.
              </div>
            </div>
          </div>

          <!-- RIGHT -->
          <div class="map-col">
            <h2 style="margin:0 0 2px 0;font-size:1rem">Karte & Strecke</h2>
            <div id="map"></div>
            <div id="toll-info" class="small" style="color:var(--muted)"></div>

            <div class="thinbox" aria-label="Maut und Vignetten Details" style="padding:16px 12px">
              <div class="">Maut & Vignette ‚Äì Details</div>
              <div class="line"><div>Gesamt Maut</div><div class="mono" id="toll-total">‚Äî</div></div>
              <div class="line"><div>Gesamt Vignetten</div><div class="mono" id="vignette-total">‚Äî</div></div>
              <div class="line"><div>Summe Maut + Vignette</div><div class="mono" id="toll-vignette-sum">‚Äî</div></div>
              <div style="margin-top:10px" class="small" id="toll-breakdown"></div>
            </div>

            <div class="thinbox" aria-label="CO2 Bilanz">
              <div class="">üå± CO‚ÇÇ-Bilanz</div>
              <div class="line"><div>CO‚ÇÇ gesamt</div><div class="mono" id="co2-total">‚Äî</div></div>
              <div class="line"><div>CO‚ÇÇ pro Person</div><div class="mono" id="co2-per-person">‚Äî</div></div>
              <div class="small" style="margin-top:8px">N√§herung auf Basis deines Verbrauchs (kg CO‚ÇÇ).</div>
            </div>

            <div class="thinbox" aria-label="Vergleich Verkehrsmittel">
              <div class="">üöóüöÜ‚úàÔ∏è Vergleich (Richtwerte)</div>
              <div class="line"><div>Auto</div><div class="mono" id="cmp-car">‚Äî</div></div>
              <div class="line"><div>Bahn</div><div class="mono" id="cmp-rail">‚Äî</div></div>
              <div class="line"><div>Flug</div><div class="mono" id="cmp-flight">‚Äî</div></div>
              <div class="small" style="margin-top:8px">
                Werte in kg CO‚ÇÇ f√ºr die Strecke (Richtwerte).<br>
                Bahn &amp; Flug: <b>pro Sitzplatz</b>. Auto: <b>pro Fahrzeug</b>.
              </div>
            </div>
          </div>

        </div>
      </section>
    </section>

    <!-- SEO Block -->
    <section class="card" aria-label="Berechnung erkl√§rt">
      <h2>So berechnest du Spritkosten & Kosten pro Person</h2>
      <p class="small" style="margin-top:0">
        F√ºr schnelle √úberschl√§ge reichen Strecke (km), Verbrauch (L/100 km) und Spritpreis (‚Ç¨/L).
        Der Rechner zeigt dir zus√§tzlich Durchschnittskosten pro 100 km und die Aufteilung pro Person.
      </p>

      <div class="two-col">
        <div class="card" style="box-shadow:none;border:1px solid rgba(15,23,42,0.06);background:#fbfdff">
          <h3 style="margin:0 0 8px 0;font-size:1rem;color:var(--accent-2)">Kurzformeln</h3>
          <ul style="margin:0;padding-left:18px;line-height:1.7">
            <li><strong>Liter</strong> = km √ó Verbrauch √∑ 100</li>
            <li><strong>Spritkosten</strong> = Liter √ó Preis</li>
            <li><strong>pro Person</strong> = Gesamtkosten √∑ Personen</li>
          </ul>
        </div>

        <div class="card" style="box-shadow:none;border:1px solid rgba(15,23,42,0.06);background:#fbfdff">
          <h3 style="margin:0 0 8px 0;font-size:1rem;color:var(--accent-2)">Hinweise</h3>
          <ul style="margin:0;padding-left:18px;line-height:1.7">
            <li>Maut/Vignette sind Sch√§tzwerte.</li>
            <li>‚ÄûLaufende Kosten" sind eine einfache N√§herung.</li>
            <li>F√ºr genaue Werte: echten Verbrauch + aktuellen Preis nutzen.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Tips -->
    <section class="card" aria-label="Tipps Sprit sparen">
      <h2>Tipps: Sprit sparen & Reisekosten reduzieren</h2>
      <p class="small" style="margin-top:0">
        Kleine √Ñnderungen senken die Kosten schnell: richtiger Reifendruck, gleichm√§√üige Geschwindigkeit
        und realistische Verbrauchswerte. Wenn ihr zusammen fahrt, teilt die Kosten fair pro Person.
      </p>
      <ul style="margin:0;padding-left:18px;line-height:1.7">
        <li><strong>Ruhig fahren:</strong> weniger stark beschleunigen und bremsen.</li>
        <li><strong>Reifendruck pr√ºfen:</strong> zu niedriger Druck erh√∂ht den Verbrauch.</li>
        <li><strong>Gewicht reduzieren:</strong> unn√∂tige Ladung raus, Dachbox nur wenn n√∂tig.</li>
        <li><strong>Kosten teilen:</strong> ‚ÄûPersonen" nutzen f√ºr fairen Betrag pro Kopf.</li>
      </ul>

      <div style="margin-top:18px;display:flex;justify-content:center">
        <a class="btn large" href="/ratgeber.html" style="max-width:320px">Zum Ratgeber</a>
      </div>
    </section>

    <!-- FAQ Short -->
    <section class="card faq-section" aria-label="FAQ">
      <h2>Kurze FAQ</h2>

      <details class="faq-item">
        <summary>Wie berechne ich Spritkosten pro 100 km?</summary>
        <p>Der Rechner zeigt dir ‚Äû‚Ç¨/100 km" automatisch an. Grundlage ist: Gesamtkosten √∑ Strecke √ó 100.</p>
      </details>

      <details class="faq-item">
        <summary>Z√§hlt Hin- und R√ºckfahrt oder nur eine Strecke?</summary>
        <p>Du kannst beides. Gib einfach die Kilometer ein, die du wirklich f√§hrst (einfach oder hin &amp; zur√ºck).</p>
      </details>

      <details class="faq-item">
        <summary>Wie genau sind Maut/Vignetten?</summary>
        <p>Nur grob nach L√§ndern. Reale Kosten h√§ngen von Route, Fahrzeugklasse und lokalen Regeln ab.</p>
      </details>

      <div style="margin-top:14px;display:flex;justify-content:center">
        <a class="btn large" href="/faq.html" style="max-width:360px">Mehr FAQ ansehen</a>
      </div>
    </section>

    <!-- Countries -->
    <section class="card countries-section" aria-label="Spritkosten-Rechner nach Land">
      <h2>Spritkosten-Rechner nach Land</h2>
      <p class="small" style="margin:0 0 10px 0">Funktioniert weltweit mit L√§nder-Erkennung. Beliebte Regionen:</p>

      <div class="countries-grid">
        <div class="country-card">
          <h3>Deutschland</h3>
          <p>Plane Fahrtkosten, Spritkosten, laufende Kosten und teile fair pro Person.</p>
        </div>
        <div class="country-card">
          <h3>√ñsterreich</h3>
          <p>Ideal f√ºr Autobahn &amp; Alpenstrecken ‚Äì inkl. grober Maut/Vignetten-Sch√§tzung.</p>
        </div>
        <div class="country-card">
          <h3>Schweiz</h3>
          <p>Perfekt f√ºr Alpenp√§sse und Autobahnen ‚Äì inkl. Vignetten-Sch√§tzung.</p>
        </div>
        <div class="country-card">
          <h3>Europa</h3>
          <p>F√ºr grenz√ºberschreitende Fahrten mit schneller Maut-/Kosten-N√§herung.</p>
        </div>
        <div class="country-card">
          <h3>Weltweit</h3>
          <p>F√ºr Roadtrips und Urlaubsreisen in nahezu allen L√§ndern &amp; Regionen.</p>
        </div>
      </div>
    </section>

    <!-- Ad: Bottom -->
    <div class="ad-block">
      <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-4852698472752437"
        data-ad-slot="3048839661"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    </div>

  </main>

  <!-- ‚úÖ Footer wird extern geladen -->
  <div id="site-footer"></div>

  <!-- ‚úÖ Cookie Banner HTML -->
  <div id="cookieBanner" class="is-hidden">
    <div class="row">
      <div class="txt">
        Wir verwenden Cookies, um die Website zu betreiben und Werbung anzuzeigen.
        <a href="/datenschutz.html">Mehr dazu</a>.
      </div>
      <div class="actions">
        <button id="cookieReject" class="reject" type="button">Ablehnen</button>
        <button id="cookieAccept" class="accept" type="button">Akzeptieren</button>
      </div>
    </div>
  </div>

  <!-- Leaflet + Prices -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/prices/country-prices.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const API_BASE = "https://soft-pine-874.dominikf974.workers.dev";
  const CURRENCY_SYMBOL = '‚Ç¨';

  const parse = v => (v === '' || v == null) ? NaN : Number(String(v).replace(',', '.'));
  const fmt = n => (Number.isFinite(n) ? Number.parseFloat(n.toFixed(2)).toFixed(2) : '0.00');
  const fmtMoney = n => CURRENCY_SYMBOL + fmt(n).replace('.', ',');
  const fmtL = n => fmt(n).replace('.', ',');

  function fetchWithTimeout(url, ms=12000){
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), ms);
    return fetch(url, { signal: controller.signal }).finally(() => clearTimeout(t));
  }

  // ---------- UI refs ----------
  const kmEl = document.getElementById('km');
  const consumptionEl = document.getElementById('consumption');
  const priceEl = document.getElementById('price');
  const passengersEl = document.getElementById('passengers');
  const fuelTypeEl = document.getElementById('fuel-type');

  const litersEl = document.getElementById('liters');
  const costFuelEl = document.getElementById('cost-fuel');
  const costRunningEl = document.getElementById('cost-running');
  const costTotalEl = document.getElementById('cost-total');
  const costPersonEl = document.getElementById('cost-person');
  const avg100El = document.getElementById('avg100');
  const runningEstEl = document.getElementById('running-est');

  const avgUnleaded91El = document.getElementById('avg-unleaded91');
  const avgUnleaded95El = document.getElementById('avg-unleaded95');
  const avgDieselEl = document.getElementById('avg-diesel');

  const tollInfoEl = document.getElementById('toll-info');
  const priceInfoEl = document.getElementById('price-info');

  const placeFromEl = document.getElementById('place-from');
  const placeToEl = document.getElementById('place-to');

  const badgeEl = document.getElementById('country-badge');
  const priceModeWrap = document.getElementById('price-mode');

  const tollTotalEl = document.getElementById('toll-total');
  const vignetteTotalEl = document.getElementById('vignette-total');
  const tollVignetteSumEl = document.getElementById('toll-vignette-sum');
  const tollBreakdownEl = document.getElementById('toll-breakdown');

  const co2TotalEl = document.getElementById('co2-total');
  const co2PerPersonEl = document.getElementById('co2-per-person');
  const cmpCarEl = document.getElementById('cmp-car');
  const cmpRailEl = document.getElementById('cmp-rail');
  const cmpFlightEl = document.getElementById('cmp-flight');

  // ---------- State ----------
  let isRouting = false;
  let lastRouteClick = 0;

  const geoCache = new Map();
  const revCache = new Map();
  const routeCache = new Map();

  const cacheKeyLL = (lat,lon) => `${lat.toFixed(5)},${lon.toFixed(5)}`;
  const cacheKeyRoute = (a,b) => `${cacheKeyLL(a.lat,a.lon)}|${cacheKeyLL(b.lat,b.lon)}`;

  let startCC = null, destCC = null;
  let routeKm = 0;

  let lastTollTotal = 0;
  let lastVignetteTotal = 0;

  // ‚úÖ NEU: echte Route-Geometrie + L√§nder-Split Cache
  let lastRouteGeo = null;              // OSRM geometry (LineString)
  let lastKmByCountry = null;           // { DE: 123.4, FR: 56.7, ... }
  let tollRenderSeq = 0;                // verhindert race conditions

  // ---------- Prices ----------
  const countryPrices = window.COUNTRY_FUEL_PRICES_EUR || null;
  const priceStand = window.COUNTRY_FUEL_PRICES_STAND || '';
  const fallbackPrices = { unleaded91: 1.50, unleaded95: 1.60, diesel: 1.45, name:'Fallback' };

  let fuelPrices = { ...fallbackPrices };
  let userEditedPrice = false;

  function renderAvgPrices(){
    avgUnleaded91El.textContent = fmtMoney(fuelPrices.unleaded91);
    avgUnleaded95El.textContent = fmtMoney(fuelPrices.unleaded95);
    avgDieselEl.textContent = fmtMoney(fuelPrices.diesel);
  }
  renderAvgPrices();

  function getMode(){
    const el = document.querySelector('input[name="priceMode"]:checked');
    return el ? el.value : 'avg';
  }

  function getCountryName(cc){
    if(!cc) return '‚Äî';
    const e = countryPrices && countryPrices[cc];
    return (e && e.name) ? e.name : cc;
  }

  async function pricesForCountryStatic(cc, lat=null, lon=null){
    cc = (cc || "").toUpperCase();

    // DE Live: Tankerk√∂nig Proxy
    if(cc === "DE" && lat != null && lon != null){
      try{
        const r = await fetchWithTimeout(`${API_BASE}/api/tank?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&rad=6&type=all`, 12000);
        if(r.ok){
          const j = await r.json();
          if(j && j.ok && Array.isArray(j.stations) && j.stations.length){
            let e10=null, e5=null, diesel=null;
            j.stations.forEach(s=>{
              if(typeof s.e10==="number")   e10   = (e10==null)   ? s.e10   : Math.min(e10, s.e10);
              if(typeof s.e5==="number")    e5    = (e5==null)    ? s.e5    : Math.min(e5, s.e5);
              if(typeof s.diesel==="number")diesel= (diesel==null)? s.diesel: Math.min(diesel, s.diesel);
            });

            const stat = (countryPrices && countryPrices[cc]) ? countryPrices[cc] : fallbackPrices;
            return {
              unleaded91: (e10   != null ? e10   : stat.unleaded91),
              unleaded95: (e5    != null ? e5    : stat.unleaded95),
              diesel:     (diesel!= null ? diesel: stat.diesel),
              name: "Deutschland (Live)"
            };
          }
        }
      }catch(e){}
    }

    const e = countryPrices && countryPrices[cc];
    if(e) return { ...e };
    return { ...fallbackPrices };
  }

  function mixPrices(a, b){
    return {
      unleaded91: (a.unleaded91 + b.unleaded91) / 2,
      unleaded95: (a.unleaded95 + b.unleaded95) / 2,
      diesel:     (a.diesel + b.diesel) / 2,
      name: `${a.name} / ${b.name}`
    };
  }

async function applyDetectedPrices(latA=null, lonA=null, latB=null, lonB=null){
  const isCross = (startCC && destCC && startCC !== destCC);
  const mode = isCross ? getMode() : 'start';

  const startP = await pricesForCountryStatic(startCC, latA, lonA);
  const destP  = await pricesForCountryStatic(destCC,  latB, lonB);

  let chosen, note;
  if(isCross){
    if(mode === 'start'){ chosen = startP; note = `Startland (${startP.name})`; }
    else if(mode === 'dest'){ chosen = destP; note = `Zielland (${destP.name})`; }
    else { chosen = mixPrices(startP, destP); note = `Mittelwert (${startP.name} ‚Üî ${destP.name})`; }
  }else{
    chosen = startP;
    note = startCC ? `Land: ${chosen.name}` : 'Land: ‚Äî';
  }

  fuelPrices = { unleaded91: chosen.unleaded91, unleaded95: chosen.unleaded95, diesel: chosen.diesel };
  renderAvgPrices();

  if(!userEditedPrice){
    priceEl.value = fuelPrices[fuelTypeEl.value] ?? '';
    priceInfoEl.textContent =
      `${note}. Durchschnittliche Spritpreise als Orientierung. Du kannst den Preis jederzeit anpassen.`;
    priceInfoEl.classList.remove('error');
  }
}

  fuelTypeEl.addEventListener('change', () => {
    if(!userEditedPrice){
      priceEl.value = fuelPrices[fuelTypeEl.value] ?? '';
    }
  });

  priceEl.addEventListener('input', () => {
    userEditedPrice = true;
    priceInfoEl.textContent = '';
    priceInfoEl.classList.remove('error');
  });

  document.getElementById('btn-reset-price').addEventListener('click', async () => {
    userEditedPrice = false;
    await applyDetectedPrices();
  });

  document.querySelectorAll('input[name="priceMode"]').forEach(r => {
    r.addEventListener('change', async () => {
      if(!userEditedPrice && startCC && destCC) await applyDetectedPrices();
      // Preis-Mode hat keinen Einfluss auf Maut, aber wir lassen es ruhig neu rendern:
      renderTollBreakdown();
    });
  });

  // ---------- Leaflet ----------
  const map = L.map('map', { attributionControl:true }).setView([51.1657, 10.4515], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom:19,
    attribution:'&copy; OpenStreetMap-Mitwirkende'
  }).addTo(map);

  function safeInvalidate(){ try { map.invalidateSize(); } catch(e){} }
  setTimeout(safeInvalidate, 80);
  setTimeout(safeInvalidate, 200);
  setTimeout(safeInvalidate, 650);
  window.addEventListener('resize', () => setTimeout(safeInvalidate, 180));
  window.addEventListener('orientationchange', () => setTimeout(safeInvalidate, 260));

  const mapEl = document.getElementById('map');
  if (window.ResizeObserver && mapEl) {
    const ro = new ResizeObserver(() => safeInvalidate());
    ro.observe(mapEl);
  }

  let markers = [];
  let routeLayer = null;

  function clearMarkers(){ markers.forEach(m=>map.removeLayer(m)); markers=[]; }
  function clearRoute(){ if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; } }
  function addMarker(lat, lon, label){
    const m = L.marker([lat, lon]).addTo(map).bindPopup(label || '');
    markers.push(m);
    return m;
  }

  // ---------- Geocoding ----------
  async function geocode(q){
    const key = q.trim().toLowerCase();
    if(geoCache.has(key)) return geoCache.get(key);

    const url = API_BASE + '/api/geocode?q=' + encodeURIComponent(q);
    const res = await fetchWithTimeout(url, 12000);
    if(!res.ok) throw new Error('Geocoding fehlgeschlagen');

    const data = await res.json();
    if(!Array.isArray(data) || !data.length) return null;

    // bevorzugt: alles au√üer reines Land
    const pick =
      data.find(x => x?.addresstype && x.addresstype !== "country") ||
      data.find(x => x?.type && x.type !== "country") ||
      data[0];

    const isCountry = (pick?.addresstype === "country" || pick?.type === "country");
    if(isCountry) return null;

    const out = { lat:+pick.lat, lon:+pick.lon, name:pick.display_name };
    geoCache.set(key, out);
    return out;
  }

  async function reverseCountryCode(lat, lon){
    const k = cacheKeyLL(lat,lon);
    if(revCache.has(k)) return revCache.get(k);

    const url = API_BASE + `/api/reverse?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
    const res = await fetchWithTimeout(url, 12000);
    if(!res.ok) return null;
    const j = await res.json();
    const cc = j?.address?.country_code ? String(j.address.country_code).toUpperCase() : null;
    revCache.set(k, cc);
    return cc;
  }

async function getRouteOSRM(lat1, lon1, lat2, lon2){
  const a = {lat:lat1, lon:lon1}, b = {lat:lat2, lon:lon2};
  const ck = cacheKeyRoute(a,b);

  // Cache nutzen
  if(routeCache.has(ck)) return routeCache.get(ck);

  // ‚ö†Ô∏è WICHTIG: nur EIN url
  // (Dein Worker entscheidet, ob er overview/geometries/steps nutzt oder ignoriert.)
  const url =
    API_BASE + `/api/route?lat1=${encodeURIComponent(lat1)}&lon1=${encodeURIComponent(lon1)}` +
    `&lat2=${encodeURIComponent(lat2)}&lon2=${encodeURIComponent(lon2)}`;

  const res = await fetchWithTimeout(url, 15000);
  if(!res.ok) throw new Error('OSRM request failed');

  const j = await res.json();
  if(!j || j.code !== 'Ok' || !j.routes || !j.routes.length) throw new Error('OSRM no route');

  const r = j.routes[0];
  const distKm = (r.distance || 0) / 1000;

  // Geometry speichern f√ºr L√§nder-Split
  lastRouteGeo = r.geometry;
  lastKmByCountry = null;

  clearRoute();
  routeLayer = L.geoJSON(r.geometry, { style: { weight: 5, opacity: 0.9 } }).addTo(map);
  map.fitBounds(routeLayer.getBounds(), { padding:[60,60] });

  setTimeout(safeInvalidate, 60);
  setTimeout(safeInvalidate, 220);

  routeCache.set(ck, distKm);
  return distKm;
}

  // ---------- "Super genau" L√§nder-Split ohne extra API ----------
  // Du brauchst: /assets/geo/countries-lite.geojson (Features mit properties.ISO_A2)
  let countriesGeo = null;
  let countriesIndex = null; // [{ iso, geom, bbox }...]

  function computeGeomBBox(geom){
    // returns [minLon,minLat,maxLon,maxLat]
    let minLon=Infinity, minLat=Infinity, maxLon=-Infinity, maxLat=-Infinity;

    function scan(coords){
      for(const c of coords){
        if(typeof c[0] === "number" && typeof c[1] === "number"){
          const lon=c[0], lat=c[1];
          if(lon<minLon) minLon=lon;
          if(lat<minLat) minLat=lat;
          if(lon>maxLon) maxLon=lon;
          if(lat>maxLat) maxLat=lat;
        } else if(Array.isArray(c)){
          scan(c);
        }
      }
    }
    scan(geom.coordinates);
    if(!Number.isFinite(minLon)) return null;
    return [minLon,minLat,maxLon,maxLat];
  }

  async function loadCountriesGeo(){
    if(countriesGeo && countriesIndex) return { countriesGeo, countriesIndex };

    // localStorage cache (optional)
    const LS_KEY = 'countriesGeo_lite_v1';
    const cached = localStorage.getItem(LS_KEY);
    if(cached){
      try{
        countriesGeo = JSON.parse(cached);
      }catch(e){
        countriesGeo = null;
      }
    }

    if(!countriesGeo){
      const r = await fetch('/assets/geo/countries-lite.geojson', { cache: 'force-cache' });
      if(!r.ok) throw new Error('countries-lite.geojson fehlt oder nicht ladbar');
      countriesGeo = await r.json();
      try{ localStorage.setItem(LS_KEY, JSON.stringify(countriesGeo)); }catch(e){}
    }

    // Index bauen (einmal)
    const idx = [];
    if(countriesGeo && Array.isArray(countriesGeo.features)){
      for(const f of countriesGeo.features){
        const iso = (f.properties?.ISO_A2 || f.properties?.iso_a2 || '').toUpperCase();
        if(!iso || iso === '-99') continue;
        const geom = f.geometry;
        if(!geom) continue;
        const bbox = f.bbox || computeGeomBBox(geom);
        idx.push({ iso, geom, bbox });
      }
    }
    countriesIndex = idx;
    return { countriesGeo, countriesIndex };
  }

  function pointInRing(point, ring){
    const x = point[0], y = point[1];
    let inside = false;
    for(let i=0, j=ring.length-1; i<ring.length; j=i++){
      const xi = ring[i][0], yi = ring[i][1];
      const xj = ring[j][0], yj = ring[j][1];
      const intersect = ((yi > y) !== (yj > y)) &&
        (x < (xj - xi) * (y - yi) / ((yj - yi) || 1e-12) + xi);
      if(intersect) inside = !inside;
    }
    return inside;
  }

  function pointInPolygon(point, geom){
    if(!geom) return false;

    if(geom.type === "Polygon"){
      const [outer, ...holes] = geom.coordinates;
      if(!pointInRing(point, outer)) return false;
      for(const h of holes) if(pointInRing(point,h)) return false;
      return true;
    }

    if(geom.type === "MultiPolygon"){
      for(const poly of geom.coordinates){
        const [outer, ...holes] = poly;
        if(!pointInRing(point, outer)) continue;
        let inHole = false;
        for(const h of holes){
          if(pointInRing(point,h)){ inHole = true; break; }
        }
        if(!inHole) return true;
      }
      return false;
    }
    return false;
  }

  function countryForLonLat(lon, lat){
    // nutzt Index (bbox -> polygon test)
    if(!countriesIndex) return null;

    for(const f of countriesIndex){
      const bb = f.bbox;
      if(bb){
        if(lon < bb[0] || lon > bb[2] || lat < bb[1] || lat > bb[3]) continue;
      }
      if(pointInPolygon([lon,lat], f.geom)) return f.iso;
    }
    return null;
  }

  function haversineKm(lat1, lon1, lat2, lon2){
    const R = 6371;
    const toRad = d => d * Math.PI / 180;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a =
      Math.sin(dLat/2)**2 +
      Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2 * R * Math.asin(Math.sqrt(a));
  }

  function downsampleLineString(coords, maxPoints=700){
    if(!coords || coords.length <= maxPoints) return coords;
    const step = Math.ceil(coords.length / maxPoints);
    const out = [];
    for(let i=0;i<coords.length;i+=step) out.push(coords[i]);
    if(out[out.length-1] !== coords[coords.length-1]) out.push(coords[coords.length-1]);
    return out;
  }

async function splitRouteByCountry(routeGeo){
  if(!routeGeo || routeGeo.type !== "LineString" || !Array.isArray(routeGeo.coordinates)) return null;

  const coordsRaw = routeGeo.coordinates; // [ [lon,lat], ... ]
  const coords = downsampleLineString(coordsRaw, 220); // weniger Punkte = weniger Arbeit
  if(coords.length < 2) return null;

  // Max. wie viele Reverse-Abfragen pro Route (wichtig gegen Blocking)
  const MAX_SAMPLES = 12;

  // Wir samplen gleichm√§√üig √ºber die Route:
  // Indizes: 0 ... last
  const sampleIdx = [];
  for(let s=0; s<MAX_SAMPLES; s++){
    const t = (MAX_SAMPLES === 1) ? 0 : s/(MAX_SAMPLES-1);
    const idx = Math.round(t * (coords.length-1));
    if(sampleIdx[sampleIdx.length-1] !== idx) sampleIdx.push(idx);
  }

  // Sample-Punkte als [lat,lon]
  const samples = sampleIdx.map(i => {
    const [lon,lat] = coords[i];
    return { lat, lon };
  });

  // Reverse auf Samples (cache sch√ºtzt)
  const sampleCC = [];
  for(const p of samples){
    const cc = await reverseCountryCode(p.lat, p.lon);
    sampleCC.push(cc || "‚Äî");
  }

  // km zwischen Samples berechnen und dem Land des jeweiligen Abschnitts zuordnen
  const kmByCC = {};
  for(let i=1;i<samples.length;i++){
    const a = samples[i-1], b = samples[i];
    const segKm = haversineKm(a.lat,a.lon,b.lat,b.lon);
    if(segKm <= 0) continue;

    // Land f√ºr Abschnitt: wenn gleich -> easy, sonst nimm Zielpunkt-Land (meist Grenz√ºbertritt)
    const ccA = sampleCC[i-1], ccB = sampleCC[i];
    const cc = (ccB && ccB !== "‚Äî") ? ccB : (ccA || "‚Äî");

    kmByCC[cc] = (kmByCC[cc] || 0) + segKm;
  }

  return kmByCC;
}

  // ---------- Toll/Vignette Model (deins, aber sauber getrennt) ----------
  // Hinweis: Das sind weiterhin Modellwerte, aber Split ist jetzt "echt".
const tollPer100km = {
  DE:0, AT:0, CH:0, FR:10, IT:9, ES:10, NL:0, BE:0,
  PL:6, CZ:0, SK:0, HU:0, SI:0, HR:5, RO:0, BG:0,
  US:3, CA:2, GB:0, AU:5, RU:1
};

  const vignetteFlat = {
    AT: 11.50, CH: 40.00, CZ: 12.00, SK: 12.00, HU: 16.00, SI: 16.00, RO: 3.50, BG: 7.50
  };

  function estimateTollForCountry(cc, km){
    const rate = (tollPer100km[cc] ?? 5);
    return Math.round(((km / 100) * rate) * 100) / 100;
  }
  function estimateVignetteForCountry(cc){
    const v = vignetteFlat[cc];
    return Number.isFinite(v) ? v : 0;
  }

  async function renderTollBreakdown(){
    const mySeq = ++tollRenderSeq;

    if(!routeKm || !lastRouteGeo){
      tollTotalEl.textContent = '‚Äî';
      vignetteTotalEl.textContent = '‚Äî';
      tollVignetteSumEl.textContent = '‚Äî';
      tollBreakdownEl.textContent = 'Gib Start/Ziel ein und berechne die Strecke.';
      lastTollTotal = 0;
      lastVignetteTotal = 0;
      return;
    }

    // Split nur einmal pro Route berechnen (cached)
    if(!lastKmByCountry){
      tollBreakdownEl.innerHTML = '<span class="small">L√§nderanteile werden aus der Route berechnet‚Ä¶</span>';
      try{
        lastKmByCountry = await splitRouteByCountry(lastRouteGeo);
      }catch(e){
        lastKmByCountry = null;
      }
    }

    // Falls inzwischen eine neue Route kam -> abbrechen
    if(mySeq !== tollRenderSeq) return;

    if(!lastKmByCountry){
      tollTotalEl.textContent = '‚Äî';
      vignetteTotalEl.textContent = '‚Äî';
      tollVignetteSumEl.textContent = '‚Äî';
      tollBreakdownEl.innerHTML = '<span class="small error">L√§nder-Split nicht verf√ºgbar (countries-lite.geojson fehlt oder Format passt nicht).</span>';
      lastTollTotal = 0;
      lastVignetteTotal = 0;
      return;
    }

    const parts = Object.entries(lastKmByCountry)
      .filter(([cc,km]) => cc && cc !== "‚Äî" && km > 0.4) // kleine Restst√ºcke raus
      .sort((a,b)=> b[1]-a[1])
      .map(([cc,km]) => ({cc, km}));

    if(!parts.length){
      tollBreakdownEl.innerHTML = '<span class="small">Keine L√§nder erkannt.</span>';
      return;
    }

    let tollSum = 0;
    let vignetteSum = 0;
    const seen = new Set();

    const lines = parts.map(p => {
      const name = getCountryName(p.cc);
      const toll = estimateTollForCountry(p.cc, p.km);
      tollSum += toll;

      if(!seen.has(p.cc)){
        vignetteSum += estimateVignetteForCountry(p.cc);
        seen.add(p.cc);
      }

      const rate = (tollPer100km[p.cc] ?? 5);
      return `‚Ä¢ ${name} (${p.cc}): ${fmtL(p.km)} km √ó ${fmt(rate).replace('.', ',')} ‚Ç¨/100 km ‚âà <b>${fmtMoney(toll)}</b>`;
    });

    lastTollTotal = tollSum;
    lastVignetteTotal = vignetteSum;

    tollTotalEl.textContent = fmtMoney(tollSum);
    vignetteTotalEl.textContent = fmtMoney(vignetteSum);
    tollVignetteSumEl.textContent = fmtMoney(tollSum + vignetteSum);

    const vignetteLine = vignetteSum > 0
      ? `<br><br><span class="small">Vignetten (fix, je Land einmal): <b>${fmtMoney(vignetteSum)}</b></span>`
      : '';

    tollBreakdownEl.innerHTML =
      lines.join('<br>') +
      vignetteLine +
      `<br><span class="small">Hinweis: Maut- und Vignettenwerte sind N√§herungen und k√∂nnen je nach Route und Fahrzeugklasse variieren.</span>`;
  }

  // ---------- Route Buttons ----------
  const btnGeocode = document.getElementById('btn-geocode');

  btnGeocode.addEventListener('click', async () => {
    const now = Date.now();
    if(isRouting) return;
    if(now - lastRouteClick < 900) return;
    lastRouteClick = now;

    const from = placeFromEl.value.trim();
    const to = placeToEl.value.trim();

    if(!from || !to){
      tollInfoEl.textContent = 'Bitte Start und Ziel eingeben.';
      tollInfoEl.classList.add('error');
      return;
    }

    try{
      isRouting = true;
      btnGeocode.disabled = true;

      tollInfoEl.textContent = 'Route wird berechnet‚Ä¶';
      tollInfoEl.classList.remove('error');

      const a = await geocode(from);
      const b = await geocode(to);
      if(!a || !b){
        tollInfoEl.textContent = 'Bitte Stadt/Ort + Land eingeben (z. B. "Paris, Frankreich"), nicht nur das Land.';
        tollInfoEl.classList.add('error');
        return;
      }

      startCC = await reverseCountryCode(a.lat, a.lon);
      destCC  = await reverseCountryCode(b.lat, b.lon);

      const startName = getCountryName(startCC);
      const destName  = getCountryName(destCC);

      badgeEl.innerHTML =
        `Erkannt: <b>Start</b> ${startName} (${startCC||'‚Äî'}), <b>Ziel</b> ${destName} (${destCC||'‚Äî'})` +
        (!countryPrices ? `<br><span class="error">‚ö† Preisdatei fehlt: prices/country-prices.js</span>` : '');

      if(startCC && destCC && startCC !== destCC) priceModeWrap.style.display = 'block';
      else priceModeWrap.style.display = 'none';

      clearMarkers();
      addMarker(a.lat,a.lon,'Start: ' + a.name);
      addMarker(b.lat,b.lon,'Ziel: ' + b.name);

      routeKm = await getRouteOSRM(a.lat, a.lon, b.lat, b.lon);
      kmEl.value = Math.round(routeKm*10)/10;

      await applyDetectedPrices(a.lat, a.lon, b.lat, b.lon);
      await renderTollBreakdown();

      tollInfoEl.textContent = `Strecke: ${fmtL(routeKm)} km.`;
      setTimeout(safeInvalidate, 120);

    }catch(e){
      tollInfoEl.textContent = 'Fehler bei Routing/Geocoding. Bitte Verbindung pr√ºfen oder anderen Ort versuchen.';
      tollInfoEl.classList.add('error');
    }finally{
      isRouting = false;
      btnGeocode.disabled = false;
    }
  });

  document.getElementById('btn-clearmap').addEventListener('click', () => {
    clearMarkers(); clearRoute();
    map.setView([51.1657, 10.4515], 5);

    placeFromEl.value = '';
    placeToEl.value = '';
    badgeEl.textContent = '';
    priceModeWrap.style.display = 'none';

    startCC = null; destCC = null;
    routeKm = 0;

    lastRouteGeo = null;
    lastKmByCountry = null;

    tollInfoEl.textContent = '';
    tollInfoEl.classList.remove('error');

    lastTollTotal = 0;
    lastVignetteTotal = 0;
    renderTollBreakdown();

    setTimeout(safeInvalidate, 120);
  });

  // Spinner km
  document.getElementById('km-inc').addEventListener('click', ()=>{ const cur = parse(kmEl.value)||0; kmEl.value = Math.round((cur+1)*10)/10; });
  document.getElementById('km-dec').addEventListener('click', ()=>{ const cur = parse(kmEl.value)||0; kmEl.value = Math.max(0, Math.round((cur-1)*10)/10); });

  // ---------- Costs ----------
  function estimateRunningPer100(consumptionL100){
    if(!Number.isFinite(consumptionL100) || consumptionL100 <= 0) return 12.0;
    const est = 1.2 * consumptionL100 + 3.5;
    return Math.max(5, Math.min(30, Math.round(est * 10) / 10));
  }

  document.getElementById('calc-fuel').addEventListener('click', () => {
    const km = parse(kmEl.value);
    const v  = parse(consumptionEl.value);
    let p    = parse(priceEl.value);
    const passengers = Math.max(1, Math.floor(parse(passengersEl.value) || 1));

    if(!Number.isFinite(p)){
      p = (fuelPrices[fuelTypeEl.value] ?? NaN);
    }
    if(Number.isNaN(km) || km <= 0 || Number.isNaN(v) || Number.isNaN(p)){
      priceInfoEl.textContent = 'Bitte Strecke, Verbrauch und Preis korrekt eingeben.';
      priceInfoEl.classList.add('error');
      return;
    }
    priceInfoEl.textContent = '';
    priceInfoEl.classList.remove('error');

    const liters = (km * v) / 100;
    const costFuel = liters * p;

    const runningPer100Base = estimateRunningPer100(v);
    const tollPer100 = (km > 0) ? ((lastTollTotal + lastVignetteTotal) / km * 100) : 0;
    const runningPer100Total = runningPer100Base + (tollPer100 || 0);

    const costRunning = (km * runningPer100Total) / 100;
    const total = costFuel + costRunning;
    const perPerson = total / passengers;
    const avgPer100 = (total / km) * 100;

    litersEl.textContent = fmtL(liters) + ' L';
    costFuelEl.textContent = fmtMoney(costFuel);
    costRunningEl.textContent = fmtMoney(costRunning);
    costTotalEl.textContent = fmtMoney(total);
    costPersonEl.textContent = fmtMoney(perPerson);
    avg100El.textContent = fmtMoney(avgPer100) + ' /100km';
    runningEstEl.textContent = fmtMoney(runningPer100Total) + ' /100km';

    // CO2
    const isDiesel = (fuelTypeEl.value === 'diesel');
    const co2FactorKgPerL = isDiesel ? 2.65 : 2.33;
    const co2Kg = liters * co2FactorKgPerL;
    const co2PerPersonKg = co2Kg / passengers;

    co2TotalEl.textContent = fmt(co2Kg).replace('.', ',') + ' kg';
    co2PerPersonEl.textContent = fmt(co2PerPersonKg).replace('.', ',') + ' kg';

    const gPerKmCar = 164;
    const gPerPkmRail = 26;
    const gPerPkmFlight = 290;

    const cmpCarKg = (km * gPerKmCar) / 1000;
    const cmpRailKg = (km * passengers * gPerPkmRail) / 1000;
    const cmpFlightKg = (km * passengers * gPerPkmFlight) / 1000;

    cmpCarEl.textContent = fmt(cmpCarKg).replace('.', ',') + ' kg';
    cmpRailEl.textContent = fmt(cmpRailKg).replace('.', ',') + ' kg';
    cmpFlightEl.textContent = fmt(cmpFlightKg).replace('.', ',') + ' kg';
  });

  document.getElementById('reset-fuel').addEventListener('click', () => {
    kmEl.value = '';
    consumptionEl.value = '7.5';
    priceEl.value = '';
    passengersEl.value = 1;

    litersEl.textContent='0,00 L';
    costFuelEl.textContent='‚Ç¨0,00';
    costRunningEl.textContent='‚Ç¨0,00';
    costTotalEl.textContent='‚Ç¨0,00';
    costPersonEl.textContent='‚Ç¨0,00';
    avg100El.textContent='‚Ç¨0,00 /100km';
    runningEstEl.textContent='‚Äî';

    co2TotalEl.textContent='‚Äî';
    co2PerPersonEl.textContent='‚Äî';
    cmpCarEl.textContent='‚Äî';
    cmpRailEl.textContent='‚Äî';
    cmpFlightEl.textContent='‚Äî';

    userEditedPrice = false;
    fuelPrices = { ...fallbackPrices };
    renderAvgPrices();

    lastTollTotal = 0;
    lastVignetteTotal = 0;

    // Route-Daten zur√ºcksetzen
    lastRouteGeo = null;
    lastKmByCountry = null;
    routeKm = 0;

    renderTollBreakdown();

    clearMarkers();
    clearRoute();
    map.setView([51.1657, 10.4515],5);
    setTimeout(safeInvalidate, 120);
  });

  // initial
  renderTollBreakdown();
});
</script>

  <!-- ‚úÖ Active Nav -->
  <script src="/assets/js/active-nav.js" defer></script>

  <!-- ‚úÖ Cookies -->
  <script src="/assets/js/cookies.js" defer></script>

  <!-- ‚úÖ Header/Footer Loader + Mobile Nav init -->
  <script>
    async function loadPart(id, url){
      const el = document.getElementById(id);
      if(!el) return false;
      try{
        const r = await fetch(url, { cache: 'no-cache' });
        el.innerHTML = await r.text();
        return true;
      }catch(e){
        console.warn('Konnte nicht laden:', url);
        return false;
      }
    }

    function initMobileNav(){
      const header = document.querySelector('.site-header');
      const btn = document.querySelector('.nav-toggle');
      const nav = document.getElementById('site-nav');
      if(!header || !btn || !nav) return;

      const close = () => {
        header.classList.remove('is-open');
        btn.setAttribute('aria-expanded', 'false');
        btn.setAttribute('aria-label', 'Men√º √∂ffnen');
      };

      const open = () => {
        header.classList.add('is-open');
        btn.setAttribute('aria-expanded', 'true');
        btn.setAttribute('aria-label', 'Men√º schlie√üen');
      };

      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        header.classList.contains('is-open') ? close() : open();
      });

      document.addEventListener('click', (e) => {
        if(!header.classList.contains('is-open')) return;
        if(header.contains(e.target)) return;
        close();
      });

      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape') close();
      });

      window.addEventListener('resize', () => {
        if(window.innerWidth > 720) close();
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadPart('site-header', '/practice/header.html');
      await loadPart('site-footer', '/practice/footer.html');
      initMobileNav();
    });
  </script>

</body>
</html>














